<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIU Student Hub — Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071028; --card:#071827; --accent:#6d28d9; --accent-2:#06b6d4;
      --muted:#9aa8bf; --glass: rgba(255,255,255,0.03); --radius:14px;
      --success:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    html,body{height:100%;margin:0;background:
      radial-gradient(900px 400px at 10% 10%, rgba(109,40,217,0.06), transparent 8%),
      linear-gradient(180deg,#041026 0%, #071028 100%);
      color:#e6eef8;-webkit-font-smoothing:antialiased;padding:20px;}
    .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:20px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(2,6,23,0.6)}
    .profile-header{display:flex;flex-direction:column;align-items:center;gap:12px;text-align:center}
    
    /* UPGRADED TO CIRCULAR STYLE */
    .avatar{
      width:120px;
      height:120px;
      border-radius:50%; /* Changed from 16px to 50% */
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color:#fff;
      font-size:32px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
      border: 4px solid rgba(255,255,255,0.05);
    }
    
    .name{font-weight:800;font-size:18px}
    .muted{color:var(--muted)}
    
    /* BLUE TICK STYLE */
    .blue-tick{
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:#0ea5e9;
      font-weight:700;
      background: rgba(14, 165, 233, 0.1);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
    }
    
    .small{font-size:13px;color:var(--muted)}
    .form-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    input[type="text"], input[type="url"], select, textarea {width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8}
    textarea{min-height:80px}
    .btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#f97316)}
    .section-title{font-weight:800;margin-bottom:8px}
    .social-list{display:flex;flex-direction:column;gap:8px}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
    .calc-list{display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto;padding-right:6px}
    .calc-item{padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.03),transparent);margin:12px 0;border-radius:2px}
    @media (max-width:980px){.container{grid-template-columns:1fr;}}
    .fade-in{animation:fadeUp .45s ease-out both}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .link{color:var(--accent);text-decoration:none;font-weight:700}
    .status-pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:700}
    .row{display:flex;gap:8px;align-items:center}
    .muted-2{color:#9fb6d6}
  </style>
</head>
<body>
  <div class="container">
    <aside class="card fade-in" id="leftCard">
      <div class="profile-header" id="profileHeader">
        <div id="avatarEl" class="avatar">BI</div>
        <div class="name" id="displayName">Student</div>
        <div class="small muted" id="displayEmail">—</div>
        <div id="verifiedBadge" style="margin-top:6px"></div>
      </div>

      <div class="divider"></div>

      <div>
        <div class="section-title">Profile Picture (Google Drive)</div>
        <div class="note">Verified images folder: <span class="muted-2">ProfilePics</span></div>
        <div style="margin-top:8px">
          <input id="profilePicLink" type="url" placeholder="Paste Drive share link" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="savePicLinkBtn" class="btn">Save Link</button>
            <button id="clearPicBtn" class="btn btn-ghost">Clear</button>
          </div>
          <div id="picStatus" class="small muted" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div>
        <div class="section-title">Verification Proof</div>
        <div class="note">Upload receipt to PaymentProofs folder and paste link.</div>
        <div style="margin-top:8px">
          <input id="proofLink" type="url" placeholder="Paste proof link" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="submitProofLinkBtn" class="btn">Submit Link</button>
            <button id="requestVerifyBtn" class="btn btn-ghost">Request Verification</button>
          </div>
          <div id="proofStatus" class="small muted" style="margin-top:8px"></div>
        </div>
      </div>
    </aside>

    <main class="card fade-in" id="mainCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="section-title">Edit Profile</div>
          <div class="small muted">Update your information and social handles.</div>
        </div>
        <button id="signOutBtn" class="btn ghost">Sign out</button>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label class="small">Full name</label>
          <input id="fullName" type="text" placeholder="Jane Doe" />
        </div>
        <div>
          <label class="small">Level</label>
          <select id="levelSelect">
            <option value="100">100L</option>
            <option value="200">200L</option>
            <option value="300">300L</option>
            <option value="400">400L</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="small">Bio (optional)</label>
        <textarea id="bio" placeholder="Tell us about yourself..."></textarea>
      </div>

      <div style="margin-top:12px">
        <div class="section-title">Social Links</div>
        <div class="social-list">
          <input id="instagram" type="url" placeholder="Instagram (https://...)" />
          <input id="tiktok" type="url" placeholder="TikTok (https://...)" />
          <input id="linkedin" type="url" placeholder="LinkedIn (https://...)" />
        </div>
        <div style="display:flex;gap:8px;margin-top:16px">
          <button id="saveLinksBtn" class="btn">Save Profile Changes</button>
          <button id="deleteProfileBtn" class="btn ghost danger">Delete Profile</button>
        </div>
        <div id="saveStatus" class="small muted" style="margin-top:8px"></div>
      </div>

      <div class="divider"></div>

      <div>
        <div class="section-title">Saved Calculations</div>
        <div id="calcHistory" class="calc-list"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="refreshHistory" class="btn ghost">Refresh</button>
          <button id="exportHistory" class="btn">Copy All</button>
        </div>
      </div>

      <div class="divider"></div>

      <div>
        <div class="section-title">Share Profile</div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <input id="publicLink" type="text" readonly />
          <button id="copyLinkBtn" class="btn ghost">Copy</button>
          <button id="viewPublicBtn" class="btn">View Public</button>
        </div>
      </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBsVbLw4mvFTJhmORUXCUNyGc98Rripj3M",
      authDomain: "biu-students-hub.firebaseapp.com",
      projectId: "biu-students-hub",
      storageBucket: "biu-students-hub.firebasestorage.app",
      messagingSenderId: "128818531382",
      appId: "1:128818531382:web:190dc5688d1b9d21321c97",
      measurementId: "G-ELK8KN5SK7"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // UI ELEMENTS
    const avatarEl = document.getElementById('avatarEl');
    const displayNameEl = document.getElementById('displayName');
    const displayEmailEl = document.getElementById('displayEmail');
    const verifiedBadge = document.getElementById('verifiedBadge');
    const profilePicLinkInput = document.getElementById('profilePicLink');
    const savePicLinkBtn = document.getElementById('savePicLinkBtn');
    const clearPicBtn = document.getElementById('clearPicBtn');
    const picStatus = document.getElementById('picStatus');
    const proofLinkInput = document.getElementById('proofLink');
    const submitProofLinkBtn = document.getElementById('submitProofLinkBtn');
    const requestVerifyBtn = document.getElementById('requestVerifyBtn');
    const proofStatus = document.getElementById('proofStatus');
    const fullNameInput = document.getElementById('fullName');
    const levelSelect = document.getElementById('levelSelect');
    const bioInput = document.getElementById('bio');
    const instagramInput = document.getElementById('instagram');
    const tiktokInput = document.getElementById('tiktok');
    const linkedinInput = document.getElementById('linkedin');
    const saveLinksBtn = document.getElementById('saveLinksBtn');
    const deleteProfileBtn = document.getElementById('deleteProfileBtn');
    const saveStatus = document.getElementById('saveStatus');
    const calcHistoryEl = document.getElementById('calcHistory');
    const refreshHistoryBtn = document.getElementById('refreshHistory');
    const exportHistoryBtn = document.getElementById('exportHistory');
    const signOutBtn = document.getElementById('signOutBtn');
    const publicLinkInput = document.getElementById('publicLink');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const viewPublicBtn = document.getElementById('viewPublicBtn');

    const urlParams = new URLSearchParams(window.location.search);
    const viewUid = urlParams.get('uid');
    let currentUid = null;
    let isOwner = false;

    // DRIVE HELPERS
    function driveFileIdFromUrl(url){
      if(!url) return null;
      const m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if(m && m[1]) return m[1];
      try {
        const u = new URL(url);
        return u.searchParams.get('id');
      } catch(e) { return null; }
    }
    function driveViewUrl(url){
      const id = driveFileIdFromUrl(url);
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
    }

    function shortInitials(name){
      if(!name) return 'BI';
      return name.split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
    }

    function showProfileUI(data, uid){
      displayNameEl.textContent = data.fullName || 'Student';
      displayEmailEl.textContent = data.email || '';
      
      // Verified Tick logic
      if(data.verified){
        verifiedBadge.innerHTML = '<span class="blue-tick"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M22.5 12.5L20.3 10L20.6 6.8L17.5 6.1L15.8 3.3L12.5 4.7L9.2 3.3L7.5 6.1L4.4 6.8L4.7 10L2.5 12.5L4.7 15L4.4 18.2L7.5 18.9L9.2 21.7L12.5 20.3L15.8 21.7L17.5 18.9L20.6 18.2L20.3 15L22.5 12.5ZM10.5 17L6.5 13L7.9 11.6L10.5 14.2L16.1 8.6L17.5 10L10.5 17Z" /></svg> Verified Member</span>';
      } else {
        verifiedBadge.innerHTML = '<span class="status-pill">Pending Verification</span>';
      }

      // Profile Pic logic
      if(data.profilePicUrl){
        avatarEl.style.backgroundImage = `url(${driveViewUrl(data.profilePicUrl)})`;
        avatarEl.textContent = '';
      } else {
        avatarEl.style.backgroundImage = '';
        avatarEl.textContent = data.fullName ? shortInitials(data.fullName) : 'BI';
      }

      if(isOwner){
        fullNameInput.value = data.fullName || '';
        levelSelect.value = data.level || '100';
        bioInput.value = data.bio || '';
        instagramInput.value = (data.social && data.social.instagram) || '';
        tiktokInput.value = (data.social && data.social.tiktok) || '';
        linkedinInput.value = (data.social && data.social.linkedin) || '';
        profilePicLinkInput.value = data.profilePicUrl || '';
      } else {
        [fullNameInput, levelSelect, bioInput, instagramInput, tiktokInput, linkedinInput, saveLinksBtn, savePicLinkBtn, submitProofLinkBtn, requestVerifyBtn, deleteProfileBtn, profilePicLinkInput, proofLinkInput, clearPicBtn].forEach(el => el.disabled = true);
      }
      publicLinkInput.value = `${location.origin}${location.pathname}?uid=${uid}`;
    }

    async function loadProfile(uidToLoad){
      const snap = await db.ref(`profiles/${uidToLoad}`).once('value');
      showProfileUI(snap.val() || {}, uidToLoad);
    }

    saveLinksBtn.addEventListener('click', async () => {
      const updates = {
        fullName: fullNameInput.value.trim(),
        level: levelSelect.value,
        bio: bioInput.value.trim(),
        social: {
          instagram: instagramInput.value.trim(),
          tiktok: tiktokInput.value.trim(),
          linkedin: linkedinInput.value.trim()
        }
      };
      await db.ref(`profiles/${currentUid}`).update(updates);
      saveStatus.textContent = 'Profile updated successfully!';
      setTimeout(() => saveStatus.textContent = '', 2000);
      loadProfile(currentUid);
    });

    savePicLinkBtn.addEventListener('click', async () => {
      const url = profilePicLinkInput.value.trim();
      if(!url) return alert('Please paste a link first.');
      await db.ref(`profiles/${currentUid}`).update({ profilePicUrl: url });
      picStatus.textContent = 'Picture saved!';
      loadProfile(currentUid);
      setTimeout(() => picStatus.textContent = '', 2000);
    });

    clearPicBtn.addEventListener('click', async () => {
      if(!confirm('Remove profile picture?')) return;
      await db.ref(`profiles/${currentUid}/profilePicUrl`).remove();
      loadProfile(currentUid);
    });

    submitProofLinkBtn.addEventListener('click', async () => {
      const url = proofLinkInput.value.trim();
      if(!url) return alert('Paste the link to your proof.');
      const ref = db.ref(`paymentProofs/${currentUid}`).push();
      await ref.set({
        proofId: ref.key,
        uid: currentUid,
        fullName: fullNameInput.value || 'Student',
        url: url,
        status: 'uploaded',
        uploadedAt: firebase.database.ServerValue.TIMESTAMP
      });
      proofStatus.textContent = 'Proof submitted for review.';
      proofLinkInput.value = '';
    });

    requestVerifyBtn.addEventListener('click', () => {
      alert('Verification request sent to admin. Please ensure you have submitted your proof link first.');
    });

    async function loadCalculations(){
      if(!currentUid) return;
      const snap = await db.ref(`profiles/${currentUid}/calculations`).once('value');
      calcHistoryEl.innerHTML = '';
      snap.forEach(child => {
        const item = child.val();
        const el = document.createElement('div');
        el.className = 'calc-item';
        el.innerHTML = `<div style="display:flex;justify-content:space-between">
          <span>${item.label || 'Saved GPA'}</span>
          <strong>${Number(item.gpa).toFixed(2)}</strong>
        </div>`;
        calcHistoryEl.appendChild(el);
      });
    }

    signOutBtn.addEventListener('click', () => auth.signOut().then(() => window.location.href = 'index.html'));

    copyLinkBtn.addEventListener('click', () => {
      publicLinkInput.select();
      document.execCommand('copy');
      alert('Link copied to clipboard!');
    });

    viewPublicBtn.addEventListener('click', () => window.open(publicLinkInput.value, '_blank'));

    auth.onAuthStateChanged(async (user) => {
      if(user){
        currentUid = user.uid;
        isOwner = (!viewUid) || (viewUid === currentUid);
        const uidToLoad = viewUid || currentUid;
        
        // Auto-create profile if new user
        const snap = await db.ref(`profiles/${uidToLoad}`).once('value');
        if(!snap.exists() && isOwner){
           await db.ref(`profiles/${currentUid}`).set({
              fullName: user.displayName || '',
              email: user.email,
              level: '100',
              verified: false,
              createdAt: firebase.database.ServerValue.TIMESTAMP
           });
        }
        showProfileUI(snap.val() || {}, uidToLoad);
        loadCalculations();
      } else if (!viewUid) {
        window.location.href = 'login.html';
      } else {
        loadProfile(viewUid); // Allow viewing public profile while logged out
      }
    });

  </script>
</body>
</html>