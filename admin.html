<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BIU Student Hub — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
--bg:#071028;
--card:#071827;
--accent:#6d28d9;
--accent-2:#06b6d4;
--muted:#9aa8bf;
--glass: rgba(255,255,255,0.03);
--radius:14px;
--max-width:1100px;
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
html,body{height:100%;margin:0;background:
radial-gradient(900px 400px at 10% 10%, rgba(109,40,217,0.06), transparent 8%),
linear-gradient(180deg,#041026 0%, #071028 100%);
color:#e6eef8;-webkit-font-smoothing:antialiased;}
.wrap{max-width:var(--max-width);margin:28px auto;padding:20px;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
h1{margin:0;font-size:20px}
.sub{color:var(--muted);font-size:13px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(2,6,23,0.6)}
.grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
.list{display:flex;flex-direction:column;gap:12px;max-height:64vh;overflow:auto;padding-right:6px}
.item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
.meta{display:flex;gap:12px;align-items:center}
.avatar{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
.btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.btn.danger{background:linear-gradient(90deg,#ef4444,#f97316)}
.small{font-size:13px;color:var(--muted)}
.preview{display:flex;flex-direction:column;gap:12px}
.preview img{max-width:100%;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.search{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8;margin-bottom:12px}
.notice{padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);color:var(--muted);font-size:13px}
@media (max-width:980px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="wrap">
<header>
<div class="brand">
<div class="logo">BIU</div>
<div>
<h1>Admin Dashboard</h1>
<div class="sub">Restricted access — pauladamu600@gmail.com only</div>
</div>
</div>
<div>
<button id="signOut" class="btn ghost">Sign out</button>
</div>
</header>

<div id="authNotice" class="card notice">Checking admin access…</div>

<div id="main" style="display:none">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
<div>
<div style="font-weight:800">Payment Proofs</div>
<div class="small">Review incoming verification payments and approve or reject.</div>
</div>
<div style="display:flex;gap:8px;align-items:center">
<input id="searchInput" class="search" placeholder="Search by student name or uid" style="width:320px" />
<button id="refreshBtn" class="btn ghost">Refresh</button>
</div>
</div>

<div class="grid">
<div>
<div class="list" id="proofList"></div>
</div>

<aside>
<div class="preview card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div style="font-weight:700">Selected proof</div>
<div id="selectedStatus" class="small"></div>
</div>
<div id="previewMeta" style="margin-top:8px" class="small">Select a proof to view details</div>
<div id="previewImage" style="margin-top:12px"></div>

<div id="proofActions" style="margin-top:12px;display:none">
<div class="controls">
<button id="approveBtn" class="btn">Approve & Verify</button>
<button id="rejectBtn" class="btn danger">Reject</button>
<button id="markPendingBtn" class="btn ghost">Mark Pending</button>
</div>
</div>
</div>

<div style="height:12px"></div>

<div class="card">
<div style="font-weight:700;margin-bottom:8px">Admin tools</div>
<div style="display:flex;flex-direction:column;gap:8px">
<button id="openProfiles" class="btn ghost">Open Profiles in Console</button>
<button id="downloadReport" class="btn ghost">Export pending list (copy)</button>
</div>
</div>
</aside>
</div>
</div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = { /* unchanged */ };
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let proofs = [];
let selected = null;
let proofsRef = null;
let proofsListener = null;

const ADMIN_EMAIL = 'pauladamu600@gmail.com';

const proofList = document.getElementById('proofList');
const previewMeta = document.getElementById('previewMeta');
const previewImage = document.getElementById('previewImage');
const proofActions = document.getElementById('proofActions');
const selectedStatus = document.getElementById('selectedStatus');
const approveBtn = document.getElementById('approveBtn');
const rejectBtn = document.getElementById('rejectBtn');
const markPendingBtn = document.getElementById('markPendingBtn');
const searchInput = document.getElementById('searchInput');
const signOutBtn = document.getElementById('signOut');

function lockButtons(state){
  [approveBtn,rejectBtn,markPendingBtn].forEach(btn=>{
    btn.disabled = state;
    btn.style.opacity = state ? 0.6 : 1;
  });
}

function safeInitials(str){
  if(!str) return 'U';
  return str.split(' ')
    .map(s=>s && s[0] ? s[0] : '')
    .join('')
    .substring(0,2)
    .toUpperCase() || 'U';
}

function createSafeDiv(text, className=null, bold=false){
  const div = document.createElement('div');
  if(className) div.className = className;
  if(bold) div.style.fontWeight = '700';
  div.textContent = text || '';
  return div;
}

function renderList(filter=''){
  proofList.innerHTML='';
  const filtered = proofs.filter(p=>{
    if(!filter) return true;
    const q=filter.toLowerCase();
    return (p.fullName||'').toLowerCase().includes(q) ||
           (p.email||'').toLowerCase().includes(q) ||
           (p.uid||'').toLowerCase().includes(q);
  });

  if(filtered.length===0){
    const empty = document.createElement('div');
    empty.className = 'small';
    empty.style.padding = '12px';
    empty.textContent = 'No payment proofs found.';
    proofList.appendChild(empty);
    return;
  }

  filtered.forEach(p=>{
    const el=document.createElement('div');
    el.className='item';

    const meta=document.createElement('div');
    meta.className='meta';

    const av=document.createElement('div');
    av.className='avatar';
    av.textContent=safeInitials(p.fullName||p.email);

    const info=document.createElement('div');
    info.appendChild(createSafeDiv(p.fullName||p.email||p.uid,null,true));
    info.appendChild(createSafeDiv(`${p.email||''} • ${p.uid}`,'small'));

    meta.appendChild(av);
    meta.appendChild(info);

    const right=document.createElement('div');
    right.style.display='flex';
    right.style.gap='8px';

    const status=document.createElement('div');
    status.className='small';
    status.textContent=p.status||'pending';

    const viewBtn=document.createElement('button');
    viewBtn.className='btn ghost';
    viewBtn.textContent='View';
    viewBtn.onclick=()=>selectProof(p);

    right.appendChild(status);
    right.appendChild(viewBtn);

    el.appendChild(meta);
    el.appendChild(right);
    proofList.appendChild(el);
  });
}

async function selectProof(p){
  selected=p;

  previewMeta.innerHTML='';
  previewMeta.appendChild(createSafeDiv(p.fullName||p.email||p.uid,null,true));
  previewMeta.appendChild(createSafeDiv(`UID: ${p.uid}`,'small'));

  selectedStatus.textContent=(p.status||'pending').toUpperCase();
  proofActions.style.display='block';

  previewImage.innerHTML='<div class="small">Loading image…</div>';

  try{
    let finalUrl = null;

    if(p.url){
      finalUrl = p.url;
    } else if(p.storagePath){
      finalUrl = await storage.ref(p.storagePath).getDownloadURL();
    }

    if(finalUrl){
      const link = document.createElement('a');
      link.href = finalUrl;
      link.target = "_blank";
      link.rel = "noopener noreferrer";

      const img = document.createElement('img');
      img.src = finalUrl;

      link.appendChild(img);
      previewImage.innerHTML='';
      previewImage.appendChild(link);
    } else {
      previewImage.innerHTML='<div class="small">No image available.</div>';
    }

  }catch{
    previewImage.innerHTML='<div class="small">Failed to load image.</div>';
  }
}

async function approveSelected(){
  if(!selected) return alert('Select a proof first.');
  const user=auth.currentUser;
  if(!user) return alert('Session expired.');
  if(!selected.uid||!selected.proofId)
    return alert('Invalid proof structure.');

  lockButtons(true);

  try{
    await db.ref(`profiles/${selected.uid}/verified`).set(true);

    await db.ref(`paymentProofs/${selected.uid}/${selected.proofId}`)
      .update({status:'approved',reviewedBy:user.email});

    await db.ref(`adminActions`).push({
      action:'approve_verification',
      uid:selected.uid,
      proofId:selected.proofId,
      admin:user.email,
      at:firebase.database.ServerValue.TIMESTAMP
    });

  }catch(e){
    alert(e.message);
  }

  lockButtons(false);
}

async function rejectSelected(){
  if(!selected) return alert('Select a proof first.');
  const user=auth.currentUser;
  if(!user) return alert('Session expired.');

  lockButtons(true);

  try{
    await db.ref(`paymentProofs/${selected.uid}/${selected.proofId}`)
      .update({status:'rejected',reviewedBy:user.email});
  }catch(e){
    alert(e.message);
  }

  lockButtons(false);
}

async function markPending(){
  if(!selected) return alert('Select a proof first.');
  const user=auth.currentUser;
  if(!user) return alert('Session expired.');

  lockButtons(true);

  try{
    await db.ref(`paymentProofs/${selected.uid}/${selected.proofId}`)
      .update({status:'pending',reviewedBy:user.email});
  }catch(e){
    alert(e.message);
  }

  lockButtons(false);
}

function attachProofListener(){

  if(proofsRef && proofsListener){
    proofsRef.off('value', proofsListener);
  }

  proofsRef = db.ref('paymentProofs').limitToLast(200);

  proofsListener = snap=>{
    proofs=[];

    snap.forEach(uidSnap=>{
      uidSnap.forEach(proofSnap=>{
        const d=proofSnap.val()||{};
        proofs.push({
          uid:uidSnap.key,
          proofId:proofSnap.key,
          fullName:d.fullName||d.name||'',
          email:d.email||'',
          uploadedAt:d.uploadedAt||0,
          status:d.status||'pending',
          storagePath:d.storagePath||'',
          url:d.url||''
        });
      });
    });

    proofs.sort((a,b)=>(b.uploadedAt||0)-(a.uploadedAt||0));
    renderList(searchInput.value.trim());
  };

  proofsRef.on('value', proofsListener);
}

document.getElementById('downloadReport')
.addEventListener('click',()=>{
  const pending=proofs.filter(p=>p.status==='pending');
  const text=JSON.stringify(pending,null,2);

  navigator.clipboard.writeText(text)
    .then(()=>alert('Copied to clipboard.'))
    .catch(()=>alert('Clipboard failed.'));
});

approveBtn.onclick=approveSelected;
rejectBtn.onclick=rejectSelected;
markPendingBtn.onclick=markPending;

searchInput.addEventListener('input',()=>{
  renderList(searchInput.value.trim());
});

signOutBtn.onclick=()=>{
  auth.signOut().then(()=>{
    window.location.href='/login.html';
  });
};

auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href='/login.html';
    return;
  }

  if((user.email||'').toLowerCase()!==ADMIN_EMAIL){
    window.location.href='/signup.html';
    return;
  }

  document.getElementById('authNotice').style.display='none';
  document.getElementById('main').style.display='block';

  attachProofListener();
});
</script>
</body>
</html>
