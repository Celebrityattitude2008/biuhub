<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password — BIU Student Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071028; --card:#071827; --accent:#6d28d9; --accent-2:#06b6d4;
      --muted:#9aa8bf; --radius:12px;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    html,body{height:100%;margin:0;background:
      radial-gradient(900px 400px at 10% 10%, rgba(109,40,217,0.06), transparent 8%),
      linear-gradient(180deg,#041026 0%, #071028 100%);color:#e6eef8;-webkit-font-smoothing:antialiased;}
    .wrap{max-width:520px;margin:64px auto;padding:20px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:22px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 16px;color:var(--muted)}
    label{display:block;font-size:13px;margin-top:12px;color:var(--muted)}
    input[type="password"], input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8;margin-top:6px}
    .row{display:flex;gap:8px;margin-top:16px}
    .btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .muted{color:var(--muted);font-size:13px;margin-top:12px}
    .error{color:#ffb4b4;background:rgba(255,0,0,0.04);padding:8px;border-radius:8px;margin-top:12px}
    .success{color:#bbf7d0;background:rgba(16,185,129,0.06);padding:8px;border-radius:8px;margin-top:12px}
    a.link{color:var(--accent);text-decoration:none;font-weight:700}
    @media (max-width:520px){.wrap{margin:28px 12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <h1 id="title">Reset your password</h1>
      <p class="lead">Set a new password for your account. This page is reached from the password reset link sent to your email.</p>

      <div id="statusMsg" class="muted">Verifying link…</div>

      <div id="formArea" style="display:none">
        <label for="newPassword">New password</label>
        <input id="newPassword" type="password" placeholder="At least 6 characters" autocomplete="new-password" />

        <label for="confirmPassword">Confirm new password</label>
        <input id="confirmPassword" type="password" placeholder="Repeat new password" autocomplete="new-password" />

        <div class="row">
          <button id="confirmBtn" class="btn">Set new password</button>
          <button id="cancelBtn" class="btn ghost">Cancel</button>
        </div>

        <div id="feedback" aria-live="polite"></div>
      </div>

      <div id="invalidArea" style="display:none">
        <div class="error" id="invalidMsg">This password reset link is invalid or has expired.</div>
        <div class="muted" style="margin-top:12px">Request a new reset link from the <a class="link" href="/forgot-password.html">Forgot password</a> page.</div>
      </div>

      <div style="margin-top:18px" class="muted">If you didn't request a password reset, you can ignore this message or secure your account by changing your password from your profile once signed in.</div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase config (your project)
    const firebaseConfig = {
      apiKey: "AIzaSyBsVbLw4mvFTJhmORUXCUNyGc98Rripj3M",
      authDomain: "biu-students-hub.firebaseapp.com",
      projectId: "biu-students-hub",
      storageBucket: "biu-students-hub.firebasestorage.app",
      messagingSenderId: "128818531382",
      appId: "1:128818531382:web:190dc5688d1b9d21321c97",
      measurementId: "G-ELK8KN5SK7"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Elements
    const statusMsg = document.getElementById('statusMsg');
    const formArea = document.getElementById('formArea');
    const invalidArea = document.getElementById('invalidArea');
    const invalidMsg = document.getElementById('invalidMsg');
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const feedback = document.getElementById('feedback');

    // Read query params
    const params = new URLSearchParams(window.location.search);
    const oobCode = params.get('oobCode');
    const mode = params.get('mode'); // expected 'resetPassword'

    // Validate presence of code
    if(!oobCode || mode !== 'resetPassword'){
      statusMsg.style.display = 'none';
      invalidArea.style.display = 'block';
      formArea.style.display = 'none';
    } else {
      // Verify the code and show the form
      auth.verifyPasswordResetCode(oobCode)
        .then(email => {
          statusMsg.textContent = `Resetting password for ${email}`;
          formArea.style.display = 'block';
          invalidArea.style.display = 'none';
        })
        .catch(err => {
          console.error('verifyPasswordResetCode', err);
          statusMsg.style.display = 'none';
          invalidArea.style.display = 'block';
          formArea.style.display = 'none';
        });
    }

    // Helper: show feedback
    function showError(text){
      feedback.innerHTML = `<div class="error">${text}</div>`;
    }
    function showSuccess(text){
      feedback.innerHTML = `<div class="success">${text}</div>`;
    }

    // Confirm new password
    confirmBtn.addEventListener('click', async () => {
      feedback.innerHTML = '';
      const pw = newPassword.value || '';
      const pw2 = confirmPassword.value || '';
      if(pw.length < 6){
        showError('Password must be at least 6 characters.');
        return;
      }
      if(pw !== pw2){
        showError('Passwords do not match.');
        return;
      }
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Setting…';
      try{
        await auth.confirmPasswordReset(oobCode, pw);
        showSuccess('Password updated. Redirecting to login…');
        setTimeout(()=> window.location.href = '/login.html', 1400);
      }catch(err){
        console.error('confirmPasswordReset', err);
        showError('Failed to reset password. The link may have expired or is invalid.');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Set new password';
      }
    });

    // Cancel button: go to login
    cancelBtn.addEventListener('click', () => {
      window.location.href = '/login.html';
    });

    // Accessibility: allow Enter key to submit when focused in confirmPassword
    confirmPassword.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') confirmBtn.click();
    });
  </script>
</body>
</html>
